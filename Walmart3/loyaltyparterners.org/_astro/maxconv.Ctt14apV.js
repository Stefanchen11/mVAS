class l{static instance=null;static isInitialized=!1;static resolvers=[];domain;url;token;config;constructor(t,e=null){this.domain=t,this.url=`//${t}`,this.token=e,this.config={domain:this.domain},setTimeout(()=>{this.bindInitializationEvents()},50)}static init(t,e=null){return l.instance||(l.instance=new l(t,e)),l.instance}static waitInstance(){return new Promise(t=>{l.instance&&l.isInitialized?t(l.instance):l.resolvers.push(t)})}isDefined(t){return typeof t<"u"}isFunction(t){return typeof t=="function"}isObject(t){return typeof t=="object"&&t!==null}isNumber(t){return typeof t=="number"||t instanceof Number}logError(t){typeof console<"u"&&console.error&&console.error(t)}logWarning(t){typeof console<"u"&&console.warn&&console.warn(t)}getCurrentTimeInSeconds(){return Math.floor(new Date().getTime()/1e3)}addEventListenerSafe(t,e,i,s){t.addEventListener?t.addEventListener(e,i,s):"attachEvent"in t?t.attachEvent(`on${e}`,i):t[`on${e}`]=i}_getUrlParameter(t,e){const s=new RegExp(`[\\?&#]${e}=([^&#]*)`).exec(t);if(!s)return"";const r=decodeURIComponent(s[1]||"");try{return decodeURIComponent(r)}catch{return unescape(r)}}getUrlParameter(t){return this._getUrlParameter(window.location.href,t)}getCookie(t){const i=new RegExp(`(^|;)[ ]*${t}=([^;]*)`).exec(document.cookie);return i?decodeURIComponent(i[2]):null}setCookie(t,e,i=0,s="/",r=null,o=!1,c="Lax",a=!0){let d=`${t}=${encodeURIComponent(e)};path=${s}`;if(i){const h=new Date;h.setTime(h.getTime()+i*1e3),d+=`;expires=${h.toUTCString()}`}r&&(d+=`;domain=${r}`),o&&(d+=";secure"),d+=`;SameSite=${c}`,document.cookie=d,a&&this.getCookie(t)!==e&&(this.setCookie(t,e,i,s,r,o,c,!1),this.logWarning(`There was an error setting cookie \`${t}\`. Please check domain \`${r}\` and path \`${s}\`.`))}decodeBase64XOR(t,e){if(!window.atob)return this.logError("atob function is not available"),"";const i=atob(t),s=e.toString();let r="";for(let o=0;o<i.length;o++)r+=String.fromCharCode(i.charCodeAt(o)^s.charCodeAt(Math.floor(o%s.length)));return r}extractRootDomain(t=window.location.hostname){const e=t.split("."),i=e.length-1,s=i>=3&&(e[i]+e[i-1]).length<=5;return e.splice(s?-3:-2).join(".")}sendBeacon(t,e){return new Promise(i=>{if(navigator.sendBeacon){const s=`${this.url}${t}?${e}`;try{const r=navigator.sendBeacon(s);i(r)}catch{i(!1)}}else i(!1)})}sendImageBeacon(t,e){return new Promise(i=>{const s=`${this.url}${t}?${e.replace("send_image=0","send_image=1")}`,r=new Image(1,1);r.onload=()=>{i()},r.onerror=()=>{i()},r.src=s})}sendXmlHttpRequest(t,e){return new Promise(i=>{if(window.location.protocol==="file:"){i("");return}const s=new XMLHttpRequest;s.onreadystatechange=()=>{s.readyState===4&&(s.status!==200?(this.logError(`XMLHttpRequest error, status: ${s.status}`),i("")):i(s.responseText))};const r=e?`${this.url}${t}?${e}`:`${this.url}${t}`;s.open("GET",r),s.send()})}async initialize(){const t=this.getCookie("mc_vret");let e={};try{e=t?JSON.parse(t):{}}catch{this.logError(`Failed to parse vret data: ${t}`),e={}}if(this._getUrlParameter(window.location.href,"mc_sub"))await this.handleVisitData(e);else{let i=`pl=${encodeURIComponent(window.location.href)}`;window.fbq!==void 0&&await new Promise(o=>{const c=this.getCurrentTimeInSeconds(),a=setInterval(()=>{const d=this.getCookie("_fbp");if(d||this.getCurrentTimeInSeconds()-c>=10){clearInterval(a);const h=this.getCookie("_fbc");i+=`&_fbp=${encodeURIComponent(d||"")}&_fbc=${encodeURIComponent(h||"")}`,o()}},1e3)}),this.token&&(i+=`&cmp=${this.token}`);const s=this.getCookie("mc_pdirect_data");s&&s.includes("mc_cmp=")&&s.includes("mc_tid=")&&(i+=`&pd=${encodeURIComponent(s)}`);const r=this.getReferrer();r&&(i+=`&ref=${encodeURIComponent(r)}`);try{const o=await this.sendXmlHttpRequest("/visit/log",i);let c={suc:!1};try{c=JSON.parse(o)}catch{this.logError(`Failed to parse visit response: ${o}`)}if(c.suc){const a=c.data||{};this.setCookie("mc_vret",JSON.stringify(a),2592e3,"/",`.${this.extractRootDomain()}`),this.setCookie("mc_clid",a.click_id||"",2592e3,"/",`.${this.extractRootDomain()}`),await this.handleVisitData(a)}else this.logError(`Visit error: ${c.msg||o}`)}catch{}}}async handleVisitData(t){this.config=t,l.isInitialized=!0,await this.executeCallbacks();try{this._generateLinks()}catch{this.logError("Execute generateLinks error")}}executeCallbacks(){const e=[...l.resolvers].map(async i=>{if(this.isFunction(i))try{await i(this)}catch(s){this.logError("Execute ready callback error"),this.logError(s.message)}});return l.resolvers=[],Promise.all(e)}_generateLinks(){if(!this.config||Object.keys(this.config).length===0){this.logError("Empty visit ret");return}const t=`/${this.config.domain}/click`,e=document.querySelectorAll(`a[href*="${t}"]`),i=new RegExp(`${t}([\\/\\d+]*)`);e.forEach(s=>{const r=s.getAttribute("href")||"",o=i.exec(r);if(o)if(this.config.direct){let c=null;if(o[1])try{c=parseInt(o[1].replace("/",""),10)}catch{this.logError(`parseInt failed for string: ${o[1]}`),c=null}const a=this.getCTA(c);if(!a){this.logError("CTA is undefined");return}const d=r.split("?");d[1]&&(a.url+=(a.url.includes("?")?"&":"?")+d[1]),s.setAttribute("href",a.url);const h=()=>{this.logClick("/click/log")};this.addEventListenerSafe(s,"click",h),this.addEventListenerSafe(s,"auxclick",f=>{f&&f.type==="auxclick"&&f.button===1&&this.logClick("/click/log")})}else{const c=r;s.setAttribute("href",`${c}${c.includes("?")?"&":"?"}mc_attr=${this.config.mc_attr}&mc_tid=${this.config.mc_tid}`)}})}getCTA(t){return this.isNumber(t)&&this.isObject(this.config.ctas)&&this.isDefined(this.config.ctas[t])?this.config.ctas[t]:this.config.cta}getReferrer(){let t="";try{t=window.top?.document.referrer||""}catch{if(window.parent)try{t=window.parent.document.referrer}catch{t=""}}return t===""?document.referrer:t}async getFeatures(t){const e=this.getCookie("mc_vret");let i={domain:this.domain};try{i=e?JSON.parse(e):i}catch{this.logError(`Failed to JSON parse vret data: ${e}`)}if(this.isObject(i)&&this.isDefined(i.campaign_id)){const s=await this.sendXmlHttpRequest("/visit/features",`mc_cmp=${i.campaign_id}`);let r={suc:!1};try{r=JSON.parse(s)}catch{this.logError(`Failed to parse features response: ${s}`)}if(r.suc)if(this.isObject(r.data)){const o=String(r.data.time).substring(4),c={};for(const a in r.data)a==="time"?c[a]=r.data[a]:c[this.decodeBase64XOR(a,o)]=this.decodeBase64XOR(r.data[a],o);t(c)}else this.logError("Non-object data when requesting features"),t({});else this.logError(`Get features error: ${r.msg||s}`)}else this.logWarning("No campaign id, skip getFeatureData")}async logClick(t){const e=this.getCTA(null),i=e?e.attr:"",s=t||"/click/log";await this.sendImageBeacon(s,`mc_attr=${this.config.mc_attr}&${i}`)}getFeatureData(t){this.getFeatures(t)}getTokens(){return this.config.tokens}generateLinksPublic(){this._generateLinks()}logEvent(t){this.isObject(this.config)&&this.isDefined(this.config.mc_attr)?this.sendBeacon("/event/log",`mc_event=${t}&mc_attr=${this.config.mc_attr}&mc_tid=${this.config.mc_tid}`):this.logWarning("No mc_attr, skip logEvent")}track(t){this.logEvent(t)}static async trackAsync(t){(await l.waitInstance()).track(t)}getClickID(){return this.config.click_id_v||this.config.click_id||""}logConversion(t){let e="";this.config.click_id_v?e=this.config.click_id_v:this.config.click_id&&(e=this.config.click_id);let i=`clid=${e}`;if(this.isObject(t))for(const s in t)i+=`&${s}=${encodeURIComponent(String(t[s]))}`;this.sendImageBeacon("/conv",i)}convert(t){this.logConversion({event:t})}bindInitializationEvents(){let t=!1;const e=()=>{t||(t=!0,this.initialize())};document.attachEvent&&document.readyState==="complete"||document.addEventListener&&document.readyState!=="loading"?e():(this.addEventListenerSafe(document,"DOMContentLoaded",()=>{e()}),this.addEventListenerSafe(window,"load",()=>{e()}))}buildLink(t,e={}){const i=`mc_attr=${this.config.mc_attr}&mc_tid=${this.config.mc_tid}&${new URLSearchParams(e).toString()}`;return`//${this.config.domain}/click${t?"/"+t:""}?${i}`}}var u=(n=>(n.PAGE_VIEW="page_view",n.PAGE_CLICK="page_click",n.VIEW_FORM="view_form",n.FOCUS_INPUT="focus_input",n.CLICK_ANCHOR="click_anchor",n.INTERACTION="interaction",n.IMG_CLICK="img_click",n.TEXT_CLICK="text_click",n.CTA_CLICK="cta_click",n.UNIQUE_VIEW="unique_view",n.UNIQUE_CLICK="unique_click",n.UNIQUE_LINK="unique_link",n.AUTO_JUMP="auto_jump",n.BACK_BUTTON="back_button",n.SURVEY_START="survey_start",n.SURVEY_END="survey_end",n.SCRATCH_START="scratch_start",n.SCRATCH_END="scratch_end",n.PIN_SUBMIT="pin_submit",n.RETRY_SUCCESS="retry_success",n))(u||{}),g=(n=>(n.SUBMIT_FORM="submit_form",n.VIEW_CONTENT="view_content",n))(g||{});export{l as M,u as T,g as a};
